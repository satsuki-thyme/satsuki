<title>なろう小説ランキング解析</title>
<meta charset="utf-8">
<style>
body {
  font-size: 14px;
}
#container {
  width: 100%;
  max-width: 1000px;
  margin-right: auto;
  margin-left: auto;
  padding-right: 20px;
  padding-left: 20px;
  box-sizing: border-box;
}
section {
  margin-top: 35px;
  padding-left: 30px;
}
section.indicate {
  border-left: 3px solid #18b7cd;
}
h2,
h3,
h4,
h5,
h6 {
  margin-top: 0;
  margin-bottom: 0;
  margin-left: -20px;
}
table {
  border-collapse: collapse;
}
table + table {
  margin-top: 50px;
}
td {
  vertical-align: top;
  border: 1px solid #666;
}
.progress-frame {
  width: 200px;
  height: 25px;
  padding: 0;
  border: 1px solid #666;
}
.progress-bar {
  height: 100%;
  width: 0;
  background-color: #1e3;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
var urlRankingApi = 'https://api.syosetu.com/rank/rankget/'
var urlNovelApi = 'https://api.syosetu.com/novelapi/api/'
var progress = 0                  // プログレスバーのカウンター
var out = ''                      // なろう小説ランキングAPI から取得するデータの種類
var dateSource = ''               // なろう小説ランキングAPI から取得する基準日を示す文字列。 20200101 形式
var dateRange = 0                 // なろう小説ランキングAPI から取得する日数。基準日の一日だけなら 0
var dateUnit = ''                 // なろう小説ランキングAPI から取得するランキングの期間。日間、週間、月間、年間
var dateArray = []                // なろう小説ランキングAPI から取得する日付のリスト
var rankingObject = {}            // なろう小説ランキングAPI から取得したランキングの全ての日付分が収まるオブジェクト
var ncodeArray = []               // なろう小説ランキングAPI から取得したランキングの全ての日付分から重複なしに NCODE のみを抽出したもの
var ncodeArrayLength = 0          // なろう小説ランキングAPI の上記 ncodeArray の長さ
var numberOfQuery = 0             // なろう小説ランキングAPI に問い合わせるクエリを数える
var numberOfNcode = 100           // なろう小説API から一度に取得する NCODE の数。多くするとクエリ URL が長くなって困るかも
var numberOfNcodePool = 0         // なろう小説API から一度に取得する NCODE の数を数える
var frequencyQuery = 0            // なろう小説API から GET する回数
var numberOfNcodePiece = 0        // なろう小説API から numberOfNcode * frequencyQuery で取得しきれない余りの NCODE の数
var ofParameterListArray = []     // なろう小説API から実際に取得する情報のリスト
var assemblyNovelArray = []       // なろう小説API から取得した小説情報の全て
var assemblyNovelArrayMelting = []// なろう小説API から取得した上記の assemblyNovelArray 内のネステッド・アレイを溶かしたもの
var ofParameterObject = {         // なろう小説API から取得する情報の総リスト
  "title": ["t", "", "小説名"],
  "ncode": ["n", "", "Nコード"],
  "userid": ["u", "", "作者のユーザID"],
  "writer": ["w", "", "作者名"],
  "story": ["s", "", "小説のあらすじ"],
  "biggenre": ["bg", "", "大ジャンル"],
  "genre": ["g", "", "ジャンル"],
  "keyword": ["k", "", "キーワード"],
  "general_firstup": ["gf", "", "初回掲載日"],
  "general_lastup": ["gl", "", "最終掲載日"],
  "novel_type": ["nt", "", "連載, 短編"],
  "end": ["e", "", "完結済, 連載中"],
  "general_all_no": ["ga", "", "全掲載部分数"],
  "length": ["l", "", "小説文字数"],
  "time": ["ti", "", "読了時間(分単位)"],
  "isstop": ["i", "", "長期連載停止中"],
  "isr15": ["ir", "", "R15"],
  "isbl": ["ibl", "", "ボーイズラブ"],
  "isgl": ["igl", "", "ガールズラブ"],
  "iszankoku": ["izk", "", "残酷な描写あり"],
  "istensei": ["its", "", "異世界転生"],
  "istenni": ["iti", "", "異世界転移"],
  "pc_or_k": ["p", "", "PC, ケータイ"],
  "global_point": ["gp", "", "総合評価ポイント"],
  "daily_point": ["dp", "", "日間ポイント"],
  "weekly_point": ["wp", "", "週間ポイント"],
  "monthly_point": ["mp", "", "月間ポイント"],
  "quarter_point": ["qp", "", "四半期ポイント"],
  "yearly_point": ["yp", "", "年間ポイント"],
  "fav_novel_cnt": ["f", "", "ブックマーク数"],
  "impression_cnt": ["imp", "", "感想数"],
  "review_cnt": ["r", "", "レビュー数"],
  "all_point": ["a", "", "評価点"],
  "all_hyoka_cnt": ["ah", "", "評価者数"],
  "sasie_cnt": ["sa", "", "挿絵の数"],
  "kaiwaritu": ["ka", "", "会話率"],
  "novelupdated_at": ["nu", "", "小説の更新日時"]
}
$(function() {
  $('#execute').on('click', function(event) {
    event.preventDefault()
    start('html')
  })
})
function start(sourceMedia) {
console.log('1 start') // milestone
  /*
    スタート
  */
  if (sourceMedia === 'html') {
    out = $('[name="out"]').children('option:selected').val()
    dateSource = $('[name="dateSource"]').val()
    dateRange = Number($('[name="dateRange"]').val())
    dateUnit = $('[name="dateUnit"]').children('option:selected').val()
  }
  getRankingSource()
}
function getRankingSource() {
console.log('2 getRankingSource') // milestone
  /*
    なろう小説ランキングAPI から NCODE, ポイント, ランクを、指定された日数分取得する
  */
  var counter = 0
  var dateSplitArray = (dateSource.substr(0, 4) + '/' + dateSource.substr(4, 2) + '/' + dateSource.substr(6, 2)).split('/')
  var date = new Date(dateSplitArray[0], Number(dateSplitArray[1]) - 1, Number(dateSplitArray[2]))
  for (var i = 0; dateRange >= i; i++) {
    var dateString = dateFormat(new Date(date.setDate(date.getDate() - i)))
console.log(new Date(date.setDate(date.getDate() - i)))
    dateArray.push(dateString)
    $.ajax({
      url: urlRankingApi + '?gzip=0&out=' + out + '&rtype=' + dateString + '-' + dateUnit,
      type: 'GET',
      dataType: out,
      cache: 'false',
      context: {dateString}
    })
    .done(function(data) {
      rankingObject[dateString] = data
      counter++
      if (counter === dateRange + 1) {
        makeComparisonTable_makeNcodeList(date)
      }
    })
    .fail(function() {
      alert('error!')
    })
  }
}
function makeComparisonTable_makeNcodeList(date) {
console.log('3 makeComparisonTable_makeNcodeList') // milestone
  /*
    start で取得した、指定された日数分のランキングリストから、 NCODE のみを重複なしに結合する
  */
  for (var i = 0; dateRange >= i; i++) {
console.log(dateArray)
console.log(rankingObject)
    for (var j = 0; rankingObject[dateArray[i]].length - 1 >= j; j++) {
      var work0 = rankingObject[dateArray[i]][j]['ncode']
      if (ncodeArray.indexOf(work0) < 0) {
        ncodeArray.push(work0)
      }
    }
  }
  makeComparisonTable_makeNcodeGroup(date)
}
function makeComparisonTable_makeNcodeGroup(date) {
console.log('4 makeComparisonTable_makeNcodeGroup') // milestone
  /*
    makeComparisonTable_makeNcodeList で作った NCODE のリストを、コード内で指定した数ずつグループにする
  */
  ncodeArrayLength = ncodeArray.length
  frequencyQuery = Math.ceil(ncodeArrayLength / numberOfNcode)
  numberOfNcodePiece = ncodeArrayLength % numberOfNcode
  for (var i = 0; frequencyQuery - 1 >= i; i++) {
    var queryWork0 = ''
    for (var j = 0; numberOfNcode - 1 >= j; j++) {
      queryWork0 = queryWork0 + '-' + ncodeArray[j + i * numberOfNcode]
    }
    makeComparisonTable_makeQuery(queryWork0.replace(/^-/, ''), numberOfNcode)
  }
  if (numberOfNcodePiece !== 0) {
    var queryWork1 = ''
    for (var i = ncodeArrayLength - numberOfNcodePiece; ncodeArrayLength >= i; i++) {
      queryWork1 = queryWork1 + '-' + ncodeArray[i]
    }
    makeComparisonTable_makeQuery(queryWork1.replace(/^-/, ''), numberOfNcodePiece)
  }
}
function dateFormat(date) {
console.log('0 dateFormat') // milestone
  /*
    日付の形式を変換するサブ関数
  */
  var y = new Date(date).getFullYear()
  var m = new Date(date).getMonth() + 1
  var d = new Date(date).getDate()
  y = ('000' + y).slice(-4)
  m = ('0' + m).slice(-2)
  d = ('0' + d).slice(-2)
  return y + m + d
}
function makeComparisonTable_makeQuery(groupNcode, numberOfNcode) {
console.log('5 makeComparisonTable_makeQuery') // milestone
  /*
    makeComparisonTable_makeNcodeGroup でグループにされた NCODE リストを使って API に問い合わせるクエリを作る
  */
  var ofParameter = ''
  $('#ofParameter').find('input').each(function(index, el) {
    var thisName = $(this).attr('name')
    var thisChecked = $(this).prop('checked')
    if (thisChecked) {
      ofParameter = ofParameter + '-' + ofParameterObject[thisName][0]
      ofParameterListArray.push(thisName)
    }
  })
  if (!ofParameter.match(/(?!a-z)n(?<!a-z)/)) {
    ofParameter = ofParameter + '-n'
    ofParameterListArray.push('ncode')
  }
  if (!ofParameter) {
    alert('出力項目が選択されていません')
    return false
  }
  var query = '?gzip=0&out=' + out + '&lim=' + numberOfNcode + '&of=' + ofParameter.replace(/^-/, '') + '&ncode=' + groupNcode
  makeComparisonTable_getNovelInformation(query, out, numberOfNcode)
}
function makeComparisonTable_getNovelInformation(query, out, numberOfNcode) {
console.log('6 makeComparisonTable_getNovelInformation') // milestone
  /*
    なろう小説API から NCODE 毎に、指定された小説情報を取得する
  */
  numberOfQuery++
  $.ajax({
      url: urlNovelApi + query,
      type: 'GET',
      dataType: out,
      cache: 'false'
  })
  .done(function(data) {
    assemblyNovelArray.push(data)
    numberOfNcodePool = numberOfNcodePool + numberOfNcode
    if (numberOfNcodePool === ncodeArrayLength) {
      joinRankingAndInformation(assemblyNovelArray)
    }
  })
  .fail(function() {
    alert('error!')
  })
}
function joinRankingAndInformation(assemblyNovelArray) {
console.log('7 joinRankingAndInformation') // milestone
  /*
    ランキングリストへ、小説情報のリストを、 NCODE をキーとして割り付ける
  */
  var numberOfQueryAll = (dateRange + 1) * frequencyQuery + Math.ceil(numberOfNcodePiece)
  if (numberOfQuery === numberOfQueryAll) {
    for (var i = 0; assemblyNovelArray.length - 1 >= i; i++) {
      for (var j = 0; assemblyNovelArray[i].length - 1 >= j; j++) {
        assemblyNovelArrayMelting.push(assemblyNovelArray[i][j])
      }
    }
    for (var i = 0; dateArray.length - 1 >= i; i++) {
      for (var j = 0; Object.keys(rankingObject[dateArray[i]]).length - 1 >= j; j++) {
        for (var k = 1; assemblyNovelArrayMelting.length - 1 >= k; k++) {
          if (assemblyNovelArrayMelting[k]['ncode'] === rankingObject[dateArray[i]][j]['ncode']) {
            for (var l = 0; ofParameterListArray.length - 1 >= l; l++) {
              rankingObject[dateArray[i]][j][ofParameterListArray[l]] = assemblyNovelArrayMelting[k][ofParameterListArray[l]]
            }
          }
        }
      }
    }
  }
console.log(rankingObject)
}
function writeNovel(data) {
  $('#output-area').append('<table id="novel"></table>')
  $('#novel').append('<thead></thead>')
  $('#novel').append('<tbody></tbody>')
  $('#novel thead').append('<tr></tr>')
  for (var i = 0; ofParameterListArray.length - 1 >= i; i++) {
    var headText = ofParameterObject[ofParameterListArray[i]][2]
    $('#novel thead tr').append('<td>' + headText + '</td>')
  }
  for (var i = 1; data.length - 1 >= i; i++) {
    $('#novel tbody').append('<tr class="line-' + i + '"></tr>')
    for (var j = 0; ofParameterListArray.length - 1 >= j; j++) {
      $('#novel tr.line-' + i).append('<td class="item-' + j + '"></td>')
      var itemText = ''
      if (ofParameterListArray[j] === 'biggenre' || ofParameterListArray[j] === 'genre') {
        itemText = biggenreAndGenreListObject[data[i][ofParameterListArray[j]]]
      } else {
        itemText = data[i][ofParameterListArray[j]]
      }
      $('#novel tr.line-' + i + ' td.item-' + j).text(itemText)
    }
  }
}
</script>
<div id="container">
<header>
  <h1>なろう小説ランキング解析</h1>
  <input type="button" id="execute" value="開始">
</header>
<section class="indicate">
  <h2>設定項目</h2>
  <section class="indicate">
    <h3>出力形式</h3>
    出力形式をyamlまたはjsonまたはphpを指定。未指定時はYAMLになる。outパラメータの詳細<br>
    <select name="out">
      <option value="jsonp">JSONP形式</option>
      <option value="">YAML形式(デフォルト)</option>
      <option value="json">JSON形式</option>
      <option value="php">PHPのserialize()</option>
      <option value="atom">Atomフィード</option>
    </select>
  </section>
  <section class="indicate">
    <h3>基準日</h3>
    ex.: 20200101
    <input type="text" name="dateSource" value="20200101">
    <section>
      <h4>注意事項</h4>
      <ul>
        <li>週間は火曜日分以外提供していないため、例えば 2014 年 5 月 1 日(木曜日)を指定するとエラーになります。</li>
        <li>月間は毎月 1 日分以外提供していないため、例えば 4 月 2 日を指定するとエラーになります。</li>
        <li>四半期は毎月 1 日分以外提供していないため、例えば 4 月 3 日を指定するとエラーになります。</li>
      </ul>
    </section>
  </section>
  <section class="indicate">
    <h3>期間</h3>
    基準日からさかのぼる日数。基準日のみの場合は 0 。
    <input type="text" name="dateRange" value="0">
  </section>
  <section class="indicate">
    <h3>取得単位</h3>
    <select name="dateUnit">
      <option value="d">日間</option>
      <option value="w">週間</option>
      <option value="m">月間</option>
      <option value="q">四半期</option>
      <option value="y">年間</option>
    </select>
  </section>
  <section id="ofParameter" class="indicate">
    <h3>出力項目</h3>
    出力する項目を個別に指定できます。未指定時は全項目出力されます。 転送量軽減のため、このパラメータの使用が推奨されます。 複数項目を出力する場合は-で区切ってください。詳しくは出力の項目をご覧ください。<br>
    <input type="checkbox" checked name="title">小説名<br>
    <input type="checkbox" name="ncode">Nコード<br>
    <input type="checkbox" name="userid"> 作者のユーザID(数値)<br>
    <input type="checkbox" name="writer"> 作者名<br>
    <input type="checkbox" name="story">小説のあらすじ<br>
    <input type="checkbox" name="biggenre"> 大ジャンル<br>
    <input type="checkbox" name="genre">ジャンル<br>
    <input type="checkbox" name="keyword">キーワード<br>
    <input type="checkbox" name="general_firstup">初回掲載日 YYYY-MM-DD HH:MM:SSの形式<br>
    <input type="checkbox" name="general_lastup"> 最終掲載日 YYYY-MM-DD HH:MM:SSの形式<br>
    <input type="checkbox" name="novel_type"> 連載の場合は1、短編の場合は2<br>
    <input type="checkbox" name="end">短編小説と完結済小説は0となっています。連載中は1です。<br>
    <input type="checkbox" name="general_all_no"> 全掲載部分数です。短編の場合は1です。<br>
    <input type="checkbox" name="length"> 小説文字数です。スペースや改行は文字数としてカウントしません。<br>
    <input type="checkbox" name="time"> 読了時間(分単位)です。読了時間は小説文字数÷500を切り上げした数値です。<br>
    <input type="checkbox" name="isstop"> 長期連載停止中なら1、それ以外は0です。<br>
    <input type="checkbox" name="isr15">登録必須キーワードに「R15」が含まれる場合は1、それ以外は0です。<br>
    <input type="checkbox" name="isbl"> 登録必須キーワードに「ボーイズラブ」が含まれる場合は1、それ以外は0です。<br>
    <input type="checkbox" name="isgl"> 登録必須キーワードに「ガールズラブ」が含まれる場合は1、それ以外は0です。<br>
    <input type="checkbox" name="iszankoku">登録必須キーワードに「残酷な描写あり」が含まれる場合は1、それ以外は0です。<br>
    <input type="checkbox" name="istensei"> 登録必須キーワードに「異世界転生」が含まれる場合は1、それ以外は0です。<br>
    <input type="checkbox" name="istenni">登録必須キーワードに「異世界転移」が含まれる場合は1、それ以外は0です。<br>
    <input type="checkbox" name="pc_or_k">1はケータイのみ、2はPCのみ、3はPCとケータイで投稿された作品です。対象は投稿と次話投稿時のみで、どの端末で執筆されたかを表すものではありません。<br>
    <input type="checkbox" name="global_point"> 総合評価ポイント(=(ブックマーク数×2)+評価点)<br>
    <input type="checkbox" name="daily_point">日間ポイント(ランキング集計時点から過去24時間以内で新たに登録されたブックマークや評価が対象)<br>
    <input type="checkbox" name="weekly_point"> 週間ポイント(ランキング集計時点から過去7日以内で新たに登録されたブックマークや評価が対象)<br>
    <input type="checkbox" name="monthly_point">月間ポイント(ランキング集計時点から過去30日以内で新たに登録されたブックマークや評価が対象)<br>
    <input type="checkbox" name="quarter_point">四半期ポイント(ランキング集計時点から過去90日以内で新たに登録されたブックマークや評価が対象)<br>
    <input type="checkbox" name="yearly_point"> 年間ポイント(ランキング集計時点から過去365日以内で新たに登録されたブックマークや評価が対象)<br>
    <input type="checkbox" name="fav_novel_cnt">ブックマーク数<br>
    <input type="checkbox" name="impression_cnt"> 感想数<br>
    <input type="checkbox" name="review_cnt"> レビュー数<br>
    <input type="checkbox" name="all_point">評価点<br>
    <input type="checkbox" name="all_hyoka_cnt">評価者数<br>
    <input type="checkbox" name="sasie_cnt">挿絵の数<br>
    <input type="checkbox" name="kaiwaritu">会話率<br>
    <input type="checkbox" name="novelupdated_at">小説の更新日時<br>
  </section>
</section>
<section class="indicate">
  <h2>データ取得の実行</h2>
  <button id="execute">取得開始</button>
</section>
<section class="indicate">
  <h2>出力</h2>
  <div id="output-area"></div>
</section>
</div>
