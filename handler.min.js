function makeReListURLs(){function e(e){return new Promise((t,a)=>{fetch(e).then(async e=>{e.ok?t(await e.json()):a(!1)})})}function t(e){return markup=e,marksE(e),marksP(e),new RegExp(`^.+?/(${e.map(e=>listDir+"/"+e.path).join("|")})$`)}q&&reDnExists.test(q)&&(reListURLs=e(indivMarkupFileDir+"/"+markupFile).then(e=>e).then(e=>t(e)).catch(()=>""),reListURLs=e(defaultMarkupFileDir+"/"+markupFile).then(e=>e).then(e=>t(e)).catch(()=>"")),q||(reListURLs=e(defaultMarkupFileDir+"/"+markupFile).then(e=>t(e)).catch(()=>""))}function marksP(e){marksPOK=new Promise(t=>{marksPreposition=e.filter(e=>"preposition"===e.markupType).map(e=>e.mark).reduce((e,t)=>e.concat([t]),[]),t(marksPreposition)})}function marksE(e){marksEOK=new Promise(t=>{marksEnclosure=e.filter(e=>"enclosure"===e.markupType&&e.delete).map(e=>e.mark.map(e=>e[0])).reduce((e,t)=>e.concat(t.map(e=>e)),[]),t(marksEnclosure)})}function loadFiles(){let e=[{file:`markup-special-notation${min}.css`,repo:"common"},{file:`yaml${min}.css`,repo:"yamlparse.js"}],t=[{file:`brackettool${min}.js`,repo:"brackettool.js"},{file:"comparearray.js",repo:"comparearray.js"},{file:`mdparse${min}.js`,repo:"mdparse.js"},{file:`novelparse${min}.js`,repo:"novelparse.js"},{file:`replacetool${min}.js`,repo:"replacetool.js"},{file:`wordcount${min}.js`,repo:"wordcount.js"},{file:`yamlparse${min}.js`,repo:"yamlparse.js"}],a=[],n=[];for(let t of e)a.push(new Promise(e=>{let a=document.createElement("link");a.href=`${libDir}/${t.repo}/${t.file}`,a.rel="stylesheet",document.head.appendChild(a),a.onload=(()=>{e()})}));for(let e of t)n.push(new Promise(t=>{let a=document.createElement("script");a.src=`${libDir}/${e.repo}/${e.file}`,a.async=!0,document.head.appendChild(a),a.onload=(()=>{t()})}));loadFilesOK=Promise.all([Promise.all(a),Promise.all(n)])}let fixToInternetURL=!1,characterCountLogInitializeSwitch=!1,githubRawFront="//raw.githubusercontent.com/satsuki-thyme",githubRawBack="master",internetSiteRepo="satsuki",localTextDir="my-drive/scribe/novel",basePage="index.html",indexFile="etc/index.json",indvIndexFile="README.md",libDir="lib",listDir="list",descriptionDir="description",defaultDescriptionFile="default.txt",markupFile="etc/markup.json",localSever="http://satsuki.c",internetServer="https://satsuki.me",search=new Map,laterInsertionDn="";location.search.slice(1).split("&").map(e=>e.split("=")).forEach(e=>{search.set(e[0],e[1])});let q=search.get("q"),dn=((q||"").match(/^[^/]+/)||[""])[0];search.set("page",search.get("page")||1);let server=!1===fixToInternetURL?location.origin:internetServer,textDir={"http://satsuki.c":localTextDir,"https://satsuki.me":`${githubRawFront}/${internetSiteRepo}/${githubRawBack}`}[server],baseURL={"http://satsuki.c":`${textDir}/${dn}`,"https://satsuki.me":`${githubRawFront}/${dn}/${githubRawBack}`}[server],defaultMarkupFileDir=textDir,indivMarkupFileDir=baseURL,reTextPage=new RegExp(`^${dn}/(?!.*${listDir}).*`),markup=[],reListURLs=null,reDnExists=new RegExp(`^${dn}`),marksPOK=null,marksEOK=null;makeReListURLs();let rejectFile="png|svg|gsheet",rePickFile=new RegExp(`^(?=[\\-+*]|\\d\\.).*? (.*\\.(?!.*(${rejectFile})).*)(?= *[:：])`),rubyMode=null!==localStorage.getItem("rubyMode")?localStorage.getItem("rubyMode"):"parse",newLineMode=null!==localStorage.getItem("newLineMode")?localStorage.getItem("newLineMode"):"few",orientationMode=null!==localStorage.getItem("orientationMode")?localStorage.getItem("orientationMode"):"horizontal",infoContents=null!==localStorage.getItem("infoContents")?localStorage.getItem("infoContents"):"normal",bracketMode=null!==localStorage.getItem("bracketMode")?localStorage.getItem("bracketMode"):"delete",beforeNum=30,afterNum=30,localizationArray=["DN","タイトル","説明"],tocHeadingInIndex="文書|目次",textHeadingInIndex="本文",rejectHeadingInIndex="なし",rejectHeadingInIndexForDisplay="マインドマップ",reTocBlob=new RegExp(`(^|\\r?\\n)#(?<sharp>#+) (${tocHeadingInIndex})([\\s\\S]*?)([^#])(\\k<sharp>#(?!#)|\\k<sharp>(?!#)|$(?!\\r?\\n))`),reTextBlob=new RegExp(`(^|\\r?\\n)#(?<sharp>#+) (${textHeadingInIndex})([\\s\\S]*?)([^#])(\\k<sharp>#(?!#)|\\k<sharp>(?!#)|$(?!\\r?\\n))`),reRejectBlob=new RegExp(`(^|\\r?\\n)#(?<sharp>#+) (${rejectHeadingInIndex})([\\s\\S]*?)([^#])(\\k<sharp>#(?!#)|\\k<sharp>(?!#)|$(?!\\r?\\n))`),textHeadingInCover=["話","タイトル","文字数","かな : 漢字","地の文 : 台詞","平均文長"],docHeadingInCover=["タイトル"],textTableClass="text-table",docTableClass="doc-table",infoContentsDir={template:"share/template",description:`${dn}/description`},infoContentsFile={normal:"normal.txt",x:"x.txt","line-tori":"line-tori.txt","line-saejima":"line-saejima.txt"},spcFileExtArray={smmx:.1},marksPreposition=[],marksEnclosure=[],title="",currNum=0,subtitle="",textArea=null,text="",textForCopy="",htmlHeight=0,scrollValueY=Number(localStorage.getItem("scrollValueY"))||0,scrollValueX=Number(localStorage.getItem("scrollValueX"))||0,scrollRange=0,PrevOp="",PrevFile="",characterCountLogTable=null,notFoundField=null,uploadDownloadField=null,downloadButton=null,uploadButton="",html=document.querySelector("html");server===internetServer&&html.classList.add("internet");let loadFilesOK=null,min={"http://satsuki.c":"","https://satsuki.me":".min"}[server];loadFiles(),Promise.all([loadFilesOK,marksPOK,marksEOK]).then(()=>{async function e(e){let t="-",a="-",n="-",r="-";return await wordcount(await novelparse({src:await brackettool(await brackettool(e,marksPreposition,"delete-together"),marksEnclosure,"delete"),newLineMode:"raw",rubyMode:"delete",parenthesis:"normal",comment:"delete-together"})).then(e=>(e.total>0&&(t=Math.round(e.kanji/e.total*10),a=10-t,r=Math.round(e.parenthesis/e.total*10),n=10-r),[e.total,`${a} : ${t}`,`${n} : ${r}`,Math.round(e.letterLength)]))}function t(){htmlHeight=html.getBoundingClientRect().height,scrollRange=Math.floor(htmlHeight-h)}function a(){scrollValueY=document.scrollingElement.scrollTop,scrollValueX=-(c.getBoundingClientRect().left-c.getBoundingClientRect().right+c.getBoundingClientRect().width)}function n(e){if("vertical"===e){let e=(htmlHeight-600)/2;c.style.paddingTop=`${e}px`,c.style.paddingBottom=`${e}px`}else c.style.paddingTop="",c.style.paddingBottom=""}function r(e,t,a,n){let r=n?` id="${n}"`:"",l=a?` class="${a}"`:"",o=e[0]instanceof Array||"array"==typeof e[0],i=!!t,s="",c="";if(o){let t="";for(let a of e)t+=`<tr><td>${a.join("</td><td>")}</td></tr>`;s=`<tbody>${t}</tbody>`}else s=`<tbody><tr><td>${e.join("</td><td>")}</td></tr></tbody>`;return i&&(c=`<thead><tr><th>${t.join("</th><th>")}</th></tr></thead>`),`<table${r+l}>${c+s}</table>`}function l(e){function t(e){return e.replace(/(\/|\\|\^|\$|\*|\+|\?|\.|\(|\)|\[|\]|\{|\})/g,"\\$1")}return"string"==typeof e||e instanceof String?t(e):Array.isArray(e)?e.map(e=>t(e)):e}function o(e,t){return("0".repeat(t)+e).slice(-t)}async function s(e){let t=e.match(/(("(?=.*([^\\](\\\\)*\\),).*"|"[^,]*"|([\d-. \t]*))[ \t]*:)?[ \t]*(("(?=.*([^\\](\\\\)*\\),).*"|"[^,]*"|([\d-. \t]*))[ \t]*,)|{|},?|\[|],?/g),a=[],n=0,r=4,l=0;return new Promise(e=>{function o(){/\{|\[/.test(t[l])&&(a.push(" ".repeat(n)+t[l]),n+=r,l<t.length-1?(l++,o()):e(a.join("\n"))),/}|]/.test(t[l])&&(n-=r,a.push(" ".repeat(n)+t[l]),l<t.length-1?(l++,o()):e(a.join("\n"))),/\{|\[|}|]/.test(t[l])||(/}|]/.test(t[l+1])&&(t[l]=t[l].replace(/,$/,"")),a.push(" ".repeat(n)+t[l]),l<t.length-1?(l++,o()):e(a.join("\n")))}o()})}let c=document.querySelector("#active-container");if(!q){html.classList.add("index"),c.innerHTML='<header>\n      <h1>作品リスト</h1>\n    </header>\n    <main>\n      <section id="op-field">\n        <div id="status-switch">\n          <label><input type="radio" name="status-switch" value="active" checked>制作中</label>\n          <label><input type="radio" name="status-switch" value="archive">アーカイブ</label>\n          <label><input type="radio" name="status-switch" value="both">両方</label>\n        </div>\n        <div id="op-list-table"></div>\n      </section>\n      <section id="not-found-field">\n      </section>\n      <section id="character-count-log-field">\n        <div id="character-count-log-table"></div>\n        <div id="upload-download-field"><p>アップロード・ダウンロード</p><input type="file" name="upload-button" accept=".json" id="upload-button"><a id="download-button" download="chacacterCountLog.json">Download</a></div>\n      </section>\n    </main>';let e=document.querySelector("#op-list-table"),n=Array.from(document.querySelectorAll('[name="status-switch"]'));function d(n){let l={failedToFetchingIndex:"index.json の読み込みに失敗しました。"};fetch(`${textDir}/${indexFile}`).then(async e=>{if(e.ok){let t=await e.json(),a=Array.from(new Set(t.filter(e=>!!("active"===n&&e.active||"archive"===n&&!e.active||"both"===n)).map(e=>[e.dn]))),l=await Promise.all(a.map(e=>{laterInsertionDn=e;let t={"http://satsuki.c":`${textDir}/${laterInsertionDn}`,"https://satsuki.me":`${githubRawFront}/${laterInsertionDn}/${githubRawBack}`};return fetch(`${t[server]}/${indvIndexFile}`).then(async a=>{if(a.ok){let n=await a.text(),r=e,l=`<a href="${basePage}?q=${r}">${n.match(/^# .*/)[0].replace(/^# /,"")}</a>`,o=await fetch(`${t[server]}/${descriptionDir}/${defaultDescriptionFile}`).then(async e=>!!e.ok&&await e.text());return[r,l,o]}return!1})}));return r(l,localizationArray)}return console.error(l.failedToFetchingIndex),!1}).then(n=>{e.innerHTML=n,t(),a()})}characterCountLogTable=document.querySelector("#character-count-log-table"),notFoundField=document.querySelector("#not-found-field"),d(n.filter(e=>e.checked)[0].value),n.forEach(e=>{e.onchange=(()=>{d(e.value)})})}if(q&&/^[^/]+$/.test(q)){async function p(){let t={failedToFetchingReadme:"${indvIndexFile} の読み込みに失敗しました。",failedToFetchingFile:"本文ファイルの取得に失敗しました。"};return await fetch(`${baseURL}/${indvIndexFile}`).then(async a=>{async function n(e){e.shift(1);let t=[],a=0,n=0,l=-1,o=0,i=!1;return new Promise(r=>{function s(){new Promise(r=>{n!==l&&(t[n]={}),l=n,t[n].text=e[a].text,i||"heading"===e[a].elemType||(e[a].headingLv=1),r(t)}).then(r=>(t[n].contents="",0===a&&"heading"!==e[a].elemType?(r[n].contents+="<section>",r):"listItem"===e[a].elemType?new Promise(t=>{(0===a||a>0&&"listItem"!==e[a-1].elemType)&&(r[n].tableElem=[],r[n].dataType=""),t(r)}).then(t=>(e[a].text?(t[n].dataType="text",a<e.length-1&&"listItem"!==e[a+1].elemType||a===e.length-1?t[n].tableElem.push(["",e[a].name].concat(e[a].count)):t[n].tableElem.push([c,`<a href="${basePage}?q=${dn}/${e[a].path}">${e[a].contents}</a>`].concat(e[a].count)),c++):(t[n].dataType="nonText",t[n].tableElem.push([`<a href="${basePage}?q=${dn}/${e[a].path}">${e[a].contents}</a>`])),t)):"paragraph"===e[a].elemType?(r[n].contents+=`<p>${e[a].contents}</p>`,r):"heading"===e[a].elemType?(i=!0,r[n].contents+=`<section><div><h${e[a].headingLv}>${e[a].contents}</h${e[a].headingLv}><div>`,r):void 0)).then(t=>{if(a<e.length-1&&"heading"===e[a+1].elemType){let r=e[a].headingLv-e[a+1].headingLv;o-=r,r>=0&&(t[n].contents+="</div>"+"</div></section>".repeat(r+1))}return a===e.length-1&&(t[n].contents+="</div>"+"</div></section>".repeat(o)),t}).then(t=>{a<e.length-1?(("listItem"!==e[a].elemType||"listItem"===e[a].elemType&&"listItem"!==e[a+1].elemType)&&n++,a++,s()):r(t)})}let c=1;s()}).then(async e=>(e[e.map(e=>e.dataType).indexOf("text")].contents=await r(e[e.map(e=>e.dataType).indexOf("text")].tableElem,textHeadingInCover,textTableClass)+e[e.map(e=>e.dataType).indexOf("text")].contents,await Promise.all(e.map(async e=>("nonText"===e.dataType&&(e.contents=await r(e.tableElem,"",docTableClass)+e.contents),e)))))}async function l(t){async function a(t){return Promise.all(t.filter(e=>"listItem"===e.elemType&&e.text).map(t=>fetch(`${baseURL}/${t.path}`).then(async a=>{if(a.ok){let n=await a.text();return t.count=await e(n),i+=n,t}return t.count=0,t}))).then(e=>{let a=0;return t.map(t=>("listItem"===t.elemType&&t.text&&(t.count=e[a].count,a++),t))})}async function n(e){let t=0;return e=e.filter((e,t)=>!o[t].reject),o=o.filter(e=>!e.reject),(await Promise.all(e.map(async(e,a)=>{let n={};return n.fieldType=o[a].fieldType,n.elemType=o[a].elemType,n.text=o[a].text,n.reject=o[a].reject,"toc"===n.fieldType&&"listItem"===n.elemType&&(n.path=e.match(/^(?:[\-+*] )(.*?)(?=[ \t]*[:：])/)[1],n.contents=e.match(/^(?:.*?:[ \t]*)(.*)/)[1],n.headingLv=t),"nonToc"===n.fieldType&&(n.contents=e),"heading"===n.elemType&&(n.headingLv=t=e.match(/^#+/)[0].length,n.contents=e.match(/^(?:#+ )(.*)/)[1]),"paragraph"!==n.elemType&&!1!==n.elemType||(n.headingLv=t),n}))).filter(e=>e.elemType)}async function r(e){let t=[],a=0,n=!1,r=!1,l=!1,o=0,i=new RegExp(`^(?<sharp>#+) (${tocHeadingInIndex})`),s=new RegExp(`^(?<sharp>#+) (${textHeadingInIndex})`),c=Math.min(...e.map(e=>{if(i.test(e))return e.match(i)[0].match(/^#+/)[0].length}).filter(e=>e)),d=new RegExp(`^#{${c}} (${tocHeadingInIndex})`),p=new RegExp(`^#{1,${c}} (?!.*(${tocHeadingInIndex})).*`),m=Math.min(...e.map(e=>{if(s.test(e))return e.match(s)[0].match(/^#+/)[0].length}).filter(e=>e)),u=new RegExp(`^#{${m}} (${textHeadingInIndex})`),h=new RegExp(`^#{1,${m}} (?!.*(${textHeadingInIndex})).*`),g=new RegExp(`^#{1,6} (${rejectHeadingInIndexForDisplay})`);return new Promise(i=>{function s(){d.test(e[a])&&(n=!0,t[a]={},t[a].fieldType="toc"),p.test(e[a])&&(n=!1,t[a]={},t[a].fieldType="nonToc"),a>0&&!d.test(e[a])&&!p.test(e[a])&&(t[a]={},t[a].fieldType=t[a-1].fieldType),0!==a||d.test(e[a])||p.test(e[a])||(t[a]={},t[a].fieldType="nonToc"),/^#+ .+/.test(e[a])&&(t[a].elemType="heading"),n&&/^[\-+*] .+/.test(e[a])&&(t[a].elemType="listItem"),/^#+ .+/.test(e[a])||/^[\-+*] .+/.test(e[a])||/^$/.test(e[a])||(t[a].elemType="paragraph"),/^$/.test(e[a])&&(t[a].elemType=!1),u.test(e[a])&&(t[a].text=!0,r=!0),h.test(e[a])&&(t[a].text=!1,r=!1),u.test(e[a])||h.test(e[a])||(t[a].text=r),g.test(e[a])?(t[a].reject=!0,l=!0,o=e[a].match(/^#+/)[0].length):l&&(!/^#/.test(e[a])||o<(e[a].match(/^#+/)||[""])[0].length)?t[a].reject=!0:(t[a].reject=!1,l=!1),a<e.length-1?(a++,s()):i(t)}s()})}let l=t.replace(/^# .*\r?\n/,"").split(/\r?\n/),o=await r(l),i="";return await n(l).then(async e=>a(e)).then(async t=>{let a=t.map(e=>e.text).lastIndexOf(!0);return t.splice(a+1,0,{fieldType:"toc",elemType:"listItem",text:!0,headingLv:t[a].headingLv,name:"<span>合</span>計",path:"",count:await e(i)}),t})}if(a.ok){let e=await a.text();return l(e).then(async e=>await n(e)).then(t=>{let a=e.match(/(?:# )(.*)/)[1],n=`<header><h1>${a}</h1><div class="return-to-index"><a href="${basePage}">インデックスページへ戻る</a></div></header>`,l="<main>",o="</main>",i=`<footer><div class="return-to-index"><a href="${basePage}">インデックスページへ戻る</a></div></footer>`,s=`<section id="list"><div><h3>リスト</h3><div>${r(markup.filter(e=>e.active).map(e=>[`<a href="?q=${dn}/${listDir}/${e.path}">${e.name}</a>`]),"")}</div></div></section>`,c=t.filter(e=>e.text).map(e=>e.contents).join(""),d=t.filter(e=>!e.text).map(e=>e.contents).join("");return[n+l+c+s+d+o+i,a]})}return console.error(t.failedToFetchingReadme),!1})}html.classList.add("cover"),p().then(e=>{c.innerHTML=e[0],document.querySelector("title").innerText=e[1],t(),a()})}if(q&&reTextPage.test(q)){html.classList.add("doc");let r=q.match(/(?:^.*?\/)(.+)$/)[1],l="";/\.md$/.test(r)?(l="markdown",html.classList.add("markdown")):/\.ya?ml$/.test(r)?(l="yaml",html.classList.add("yaml")):(l="text",html.classList.add("text"));let o="";function m(t){function a(){return fetch(`${baseURL}/${indvIndexFile}`).then(async e=>{if(e.ok){let a=await e.text(),n=a.match(reTocBlob)[0].match(/([*+\-] |\d+\. ).+/g).map(e=>e.replace(/([*+\-] |\d+\. )/,"")),r=n.map(e=>[e.match(/^.+?(?=[ \t]*[:：]|$)/)[0],e.match(/(?:[:：][ \t]*)([^ ].*)$/)[1]]);title=a.match(/(?:# )(.*)/)[1];let l=0,o=0;for(let e in r)r[e][0]===t&&(currNum=Number(e));return l=currNum>0&&r[currNum-1],o=currNum<r.length-1&&r[currNum+1],[[r[currNum][0],`第${currNum+1}話 ${r[currNum][1]}`],l,o,title]}return console.error(n.failedToFetchingFile),!1}).then(async t=>await t.concat([await e(text)]))}let n={failedToFetchingFile:"本文ファイルの取得に失敗しました。"},r={text:'<aside class="control-panel">\n            <div class="switch-set bracket-mode">\n              <span class="heading">編集用括弧</span>\n              <label><input type="radio" name="bracket-mode" value="delete" checked><span class="label">削除</span></label>\n              <label><input type="radio" name="bracket-mode" value="contents"><span class="label">ハイライト</span></label>\n            </div>\n            <div class="switch-set ruby-mode">\n              <span class="heading">ルビ</span>\n              <label><input type="radio" name="ruby-mode" value="parse" checked><span class="label">解釈</span></label>\n              <label><input type="radio" name="ruby-mode" value="open"><span class="label">開く</span></label>\n              <label><input type="radio" name="ruby-mode" value="raw"><span class="label">非解釈</span></label>\n              <label><input type="radio" name="ruby-mode" value="delete"><span class="label">削除</span></label>\n            </div>\n            <div class="switch-set new-line-mode">\n              <span class="heading">改行</span>\n              <label><input type="radio" name="new-line-mode" value="few" checked><span class="label">減少</span></label>\n              <label><input type="radio" name="new-line-mode" value="paper"><span class="label">紙書</span></label>\n              <label><input type="radio" name="new-line-mode" value="raw"><span class="label">不変</span></label>\n            </div>\n            <div class="switch-set orientation-mode">\n              <label><input type="checkbox" name="orientation-mode"><span class="label">縦</span></label>\n            </div>\n            <div class="switch-set text-select">\n              <input type="button" name="text-select" value="本文選択">\n              <label><input type="radio" name="info-contents" value="normal"><span class="label">通常</span></label>\n              <label><input type="radio" name="info-contents" value="x"><span class="label">X</span></label>\n              <label><input type="radio" name="info-contents" value="line-tori"><span class="label">とり</span></label>\n              <label><input type="radio" name="info-contents" value="line-saejima"><span class="label">さえ</span></label>\n            </div>\n          </aside>',markdown:"",yaml:""};return PrevOp=dn,PrevFile=t,fetch(`${baseURL}/${t}`).then(async e=>{if(e.ok){let t="",n="";if(text=await e.text(),"markdown"===l)o=await replacetool(await fetch("lib/common/markup-special-notation.json").then(async e=>await e.json()),await mdparse(text,{permissive:!0,section:!0}));else if("yaml"===l)o=await replacetool(await fetch("lib/common/markup-special-notation.json").then(async e=>await e.json()),(await yamlparse(text))[0]);else{let e=await brackettool(text,marksPreposition,"delete-together","hole","",beforeNum,afterNum),t=await brackettool(e,marksEnclosure,bracketMode,"hole","",beforeNum,afterNum);o=textForCopy=await novelparse({src:t,newLineMode:newLineMode,rubyMode:rubyMode,parenthesis:"normal",commnet:"delete-together"})}return a().then(e=>{subtitle=e[0][1],t=!1!==e[1]?`<a href="${basePage}?q=${dn}/${e[1][0]}">${e[1][1]}</a>`:"なし",n=!1!==e[2]?`<a href="${basePage}?q=${dn}/${e[2][0]}">${e[2][1]}</a>`:"なし";let a=`<nav><div class="left">${t}</div><div class="center"><span class="nav-separater">|</span><a href="${basePage}?q=${dn}">表紙</a><span class="nav-separater">|</span></div><div class="right">${n}</div></nav>`,i=`<main id="text-area">${o}</main>`,s=`<header><p class="context-level-1">${e[3]}</p><h1>${e[0][1]}</h1><p>文字数<span class="rot">:</span><span class="rot"> </span><span class="char-num">${e[4][0]}</span></p>${a}</header>`,c=`<footer>${a}<p>文字数<span class="rot">:</span><span class="rot"> </span><span class="char-num">${e[4][0]}</span></p></footer>`,d='<pre id="pre-area"></pre>';return[s+i+c+r[l]+d,title]})}return console.error(n.failedToFetchingFile),!1})}m(r).then(e=>{if(c.innerHTML=e[0],document.querySelector("title").innerText=e[1],t(),a(),textArea=document.querySelector("#text-area"),"text"===l){n(!1);let e=document.querySelectorAll('[name="bracket-mode"]'),l=document.querySelectorAll('[name="ruby-mode"]'),o=document.querySelectorAll('[name="new-line-mode"]'),i=document.querySelector('[name="orientation-mode"]'),s=document.querySelector('[name="text-select"]'),c=document.querySelectorAll('[name="info-contents"]');e.forEach(e=>{e.checked=bracketMode===e.value}),l.forEach(e=>{e.checked=rubyMode===e.value}),o.forEach(e=>{e.checked=newLineMode===e.value}),"horizontal"===orientationMode?i.checked=!1:(i.checked=!0,html.classList.add("vertical")),c.forEach(e=>{e.checked=infoContents===e.value}),e.forEach(e=>{e.onchange=(async()=>{bracketMode=!0===e.checked&&e.value,textArea.innerHTML=textForCopy=await novelparse({src:await brackettool(await brackettool(text,marksPreposition,"delete-together","hole","",beforeNum,afterNum),marksEnclosure,bracketMode,"hole","",beforeNum,afterNum),newLineMode:newLineMode,rubyMode:rubyMode,parenthesis:"normal",comment:"delete-together"}),t(),a()})}),l.forEach(e=>{e.onchange=(async()=>{rubyMode=!0===e.checked&&e.value,textArea.innerHTML=textForCopy=await novelparse({src:await brackettool(await brackettool(text,marksPreposition,"delete-together","hole","",beforeNum,afterNum),marksEnclosure,bracketMode,"hole","",beforeNum,afterNum),newLineMode:newLineMode,rubyMode:rubyMode,parenthesis:"normal",comment:"delete-together"}),t(),a()})}),o.forEach(e=>{e.onchange=(async()=>{newLineMode=!0===e.checked&&e.value,textArea.innerHTML=textForCopy=await novelparse({src:await brackettool(await brackettool(text,marksPreposition,"delete-together","hole","",beforeNum,afterNum),marksEnclosure,bracketMode,"hole","",beforeNum,afterNum),newLineMode:newLineMode,rubyMode:rubyMode,parenthesis:"normal",comment:"delete-together"}),t(),a()})}),i.onchange=(async()=>{orientationMode=!1===i.checked?"horizontal":"vertical",!1===i.checked?(orientationMode="horizontal",html.classList.remove("vertical")):(orientationMode="vertical",html.classList.add("vertical")),t(),a()}),c.forEach(e=>{e.onchange=(()=>{infoContents=!0===e.checked&&e.value})});let d=document.querySelector("#pre-area");s.onclick=(async()=>{async function e(){return await fetch(`${textDir}/${infoContentsDir.template}/${infoContentsFile[infoContents]}`).then(async e=>{async function t(){return!!/\$description/.test(o)&&await fetch(`${textDir}/${infoContentsDir.description}/${s}${infoContentsFile[infoContents]}`).then(async e=>await e.text())}function a(){return!!/\$text_follow_option/.test(o)&&textForCopy.replace(/(<\/p>[\s\S]*?<p>)/g,"\n").replace(/<br>/g,"").replace(/<.*?>/g,"")}async function n(){return!!/\$text_no_ruby/.test(o)&&(await novelparse({src:await brackettool(await brackettool(text,marksPreposition,"delete-together"),marksEnclosure,"delete","normal","delete-together")})).replace(/(<\/p>[\s\S]*?<p>)/g,"\n").replace(/<br>/g,"").replace(/<.*?>/g,"")}async function l(){return!!/\$text_length/.test(o)&&await wordcount(await brackettool(await brackettool(text,marksPreposition,"delete-together"),marksEnclosure,"delete"))}let o=await e.text(),i=dn.replace(/\d+$/,""),s="",c={title:title,episode_num:currNum+1,subtitle:subtitle,description:await t(),link_url:`https://satsuki.me/index.html?q=${dn}/${r}`,text_follow_option:a(),text_no_ruby:await n(),text_length:(await l()).total};c[i]=dn;for(let e in Object.keys(c)){let t=new RegExp(`\\$${Object.keys(c)[e]}(?=\\r|\\n|$|[^\\d\\w_])`,"g");o=o.replace(t,`${c[Object.keys(c)[e]]}`)}return o})}d.innerHTML=await e(),d.classList.add("display");let t=document.createRange();t.setStart(d,0),t.setEnd(d,d.childNodes.length),document.getSelection().removeAllRanges(),document.getSelection().addRange(t),d.onclick=(()=>{d.classList.remove("display")}),d.oncopy=(()=>{setTimeout(()=>{d.classList.remove("display")},1)})})}PrevOp===localStorage.getItem("PrevOp")&&PrevFile===localStorage.getItem("PrevFile")&&(document.scrollingElement.scrollTop=Number(localStorage.getItem("scrollValueY")||null),c.scrollLeft=Number(localStorage.getItem("scrollValueX")||null),scrollRange=Math.floor(htmlHeight-h)),window.addEventListener("unload",()=>{localStorage.setItem("bracketMode",bracketMode),localStorage.setItem("rubyMode",rubyMode),localStorage.setItem("newLineMode",newLineMode),localStorage.setItem("orientationMode",orientationMode),localStorage.setItem("infoContents",infoContents),localStorage.setItem("PrevOp",PrevOp),localStorage.setItem("PrevFile",PrevFile)})})}let u=new RegExp(`${dn}/list/`);q&&u.test(q)&&reListURLs.then(e=>{if(q&&e.test(q)){let e=markup.filter(e=>e.active).filter(e=>e.path===q.match(/([^/]*)$/)[0])[0];async function t(e){async function t(e,t,a,n){let r=e.replace(/\r|\n/g,""),o=[],i=Array.from(new Set(marksPreposition.map(e=>e[1]))).join(""),s=[];for(let e in t){o[e]={};let c=[l(t[e][0][0]),l(t[e][0][1])],d=[];d.push(`${c[0]}.*?${c[1]}`);let p=[];p.push(c[0]),p.push(c[1]),p=Array.from(new Set(p));let m=new RegExp(`(${d.join("|")})`,"g"),u=new RegExp(`${p.join("|")}`,"g"),h=Array.from(new Set(r.match(m)||[""]));o[e].keyword=Promise.all(h.map(async e=>(await novelparse({src:e.replace(/^.|.$/g,""),newLineMode:"unprocessed",rubyMode:"parse",parenthesis:"normal",comment:"delete-together"})).replace(/　 /,""))),o[e].description=Promise.all(h.map(async e=>{let t=new RegExp(`.{0,${a}}${l(e)}.{0,${n}}(?:[^《]*?》)?`),o=new RegExp(`(?!\\{[^${l(i)}]*)(${l(e.replace(u,""))})`),s=r.match(t)[0].replace(u,"");return(await novelparse({src:(await brackettool(await brackettool(s,marksPreposition,"delete-together"),marksEnclosure,"delete")).replace(o,'<span class="mark">$1</span>'),newLineMode:"unprocessed",rubyMode:"parse",parenthesis:"normal",comment:"delete-together"})).replace(/　 /,"")})),Promise.all(o[e].keyword,o[e].description).then(e=>{s.push(e)}),o[e].attribute=t[e][1]}return Promise.all(s).then(e=>e.map(e,t=>{e+=keywowrdList[t]}))}function a(e,t){let a=new RegExp(`${l(t[0])}.*?${l(t[1])}`,"g"),n=marksPreposition.reduce((e,t)=>e.concat(t),[]),r=new RegExp(Array.from(new Set(n)).map(e=>l(e)).join("|"),"g"),o=new RegExp(n,"g"),i=[],s=(e.split(/\r?\n|\r(?!\n)/).filter(e=>a.test(e))||[""]).map(e=>(console.log(r),console.log(e.replace(r,"")),[e.match(a).map(e=>e.replace(r,"")),e.replace(a,"").replace(o,"").replace(/^　/,"")]));for(let e of s)if(Array.isArray(e[0]))for(let t of e[0])i.push([t,e[1]]);else i.push(e);return Promise.all(Array.from(new Set(i.map(e=>e[0]))).map(async e=>[e,await novelparse({src:await brackettool(await brackettool(i.filter(t=>t[0]===e).map(e=>e[1].replace(/^　*/,"")).join("\n"),marksPreposition,"delete-together"),marksEnclosure,"delete"),newLineMode:"few",rubyMode:"parse",parenthesis:"normal",comment:"delete-together"})]))}let n=e.mark||[],o=e.markupType||"",s=e.contents||"",d=e.var[0]||"",p=e.var[1]||"",m=e.var[2]||"",u=e.var[3]||"",h=Number(e.var[4])||0,g=Number(e.var[5])||0,f=e.pagination||!1,w=e.path||"";html.classList.add(d);let y=await fetch(`${baseURL}/${indvIndexFile}`).then(async e=>!!e.ok&&await e.text()),b=`<header><h1>${y.match(/# .*/)[0].replace(/^# /,"")}</h1><h2>${s}</h2><p class="return"><a href="?q=${dn}">戻る</a></p></header>`,$=`<footer><p class="return"><a href="?q=${dn}">戻る</a></p></footer>`;Promise.all(y.match(reTextBlob)[0].match(/(?:([\-+*]|\d+ \.) )(.+?)(?= *[:：])/g).map(e=>e.replace(/([\-+*]|\d+ \.) /,"")).map(async(e,t)=>fetch(`${baseURL}/${e}`).then(async e=>!!e.ok&&[await e.text(),t]))).then(async e=>{if(f){if("enclosure"===o&&Promise.all(e.map(e=>[t(e[0],n,h,g),i]).filter(e=>""!==e[0])).then(e=>{Promise.all(e.map(async e=>{(await Promise.all(e[0].filter(e=>void 0!==e.description[0]).map(async e=>{let t=[];for(let a in e.keyword)t.push([e.description[a]]);let a=`<section><h3>${e.attribute}</h3>`,n=`<main>${await r(t,"",p,m)}</main>`,l="</section>";return a+n+l}))).join(""),e[1]})).then(e=>{console.log(e)})}),"preposition"===o){let t=await Promise.all(e.map(async(e,t)=>[await a(e[0],n),t]).filter(e=>""!==e[0])),l=`?q=${dn}/list/${w}`,o=1===Number(search.get("page"))?"":`<a href="${l}&page=${Number(search.get("page"))-1}">前ページ</a>`,i=Number(search.get("page"))===t.length?"":`<a href="${l}&page=${Number(search.get("page"))+1}">次ページ</a>`,s=1===Number(search.get("page"))||Number(search.get("page"))===t.length?"":" | ",d=`<header><h2>第 ${t[Number(search.get("page"))-1][1]+1} 話</h2><p>ページ: ${search.get("page")} / ${t.length}</p><nav>${t.map((e,t)=>t!==Number(search.get("page"))-1?`<a href="${l}&page=${e[1]+1}">${e[1]+1}</a>`:t+1).join(" | ")}</nav><nav><p class="page">${o}${s}${i}</p></nav></header>`;c.innerHTML=b+d+`<main>\n                  <ol>${t[Number(search.get("page"))-1][0].map((e,t)=>`<li><a href="#anchor${t}">${e[0]}</a></li>`).join("")}</ol>\n                  ${r(t[Number(search.get("page"))-1][0].map((e,t)=>[`<span id="anchor${t}" class="anchor"></span>${e[0]}`,e[1]]),u,p,m)}\n                </main>`+$}}else if(text=e.join(""),"enclosure"===o&&(c.innerHTML=b+(await Promise.all((await t(text,n,h,g)).filter(e=>void 0!==e.description[0]).map(async e=>{let t=[];for(let a in e.keyword)t.push([e.description[a]]);let a=`<section><h3>${e.attribute}</h3>`,n=`<main>${await r(t,"",p,m)}</main>`,l="</section>";return a+n+l}))).join("")+$),"preposition"===o){let e=await a(text,n);c.innerHTML=`${b}\n                <main>\n                  <ol>${e.map((e,t)=>`<li><a href="#anchor${t}">${e[0]}</a></li>`).join("")}</ol>\n                  ${r(e.map((e,t)=>[`<span id="anchor${t}" class="anchor"></span>${e[0]}`,e[1]]),u,p,m)}\n                </main>\n                ${$}`}})}t(e),document.querySelector("title").innerText=e.contents}}),Promise.all([loadFilesOK,marksPOK,marksEOK]).then(()=>{if(server===localSever){let t=null;function e(){function e(){let t=new Date(Date.now()),n=59,r=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),n).getTime()-t.getTime(),l=new Date(new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours()).getTime()+36e5),o=new Date(l.getFullYear(),l.getMonth(),l.getDate(),l.getHours(),n).getTime()-t.getTime();r=r>0?r:o,setTimeout(()=>{a(),e()},r)}async function a(){fetch(`${textDir}/${indexFile}`).then(async e=>e.ok?Promise.all((await e.json()).map(e=>fetch(`${textDir}/${e.dn}/${indvIndexFile}`).then(async t=>{if(t.ok){let n=(await t.text()).match(reTocBlob)[0],r=n.match(reTextBlob)||[!1],l=!1,o=0;return r&&void 0!==r[2]?(o=r[2].length,l=n.replace(reTextBlob,"").replace(reRejectBlob,"")):l=n.replace(reRejectBlob,""),[e.dn,a(r[0]),a(l)];function a(e){return!!e&&e.split(/\r?\n|\r(?!\n)/).map(e=>(e.match(rePickFile)||[!1,!1])[1]).filter(e=>e)}}return l.push(`${e.dn}/${indvIndexFile}`),!1}))):(l.push(`${textDir}/${indexFile}`),!1)).then(async e=>{function t(e,t,a){return t?Promise.all(t.map(t=>t?fetch(/^\//.test(t)?`my-drive/${t}`:`${textDir}/${e}/${t}`).then(async n=>n.ok?a?[await novelparse({src:await brackettool(await brackettool(await n.text(),marksPreposition,"delete-together","hole",""),marksEnclosure,"delete","hole",""),newLineMode:"raw",rubyMode:"delete"}),t.match(/[^.]*$/)[0]]:[await n.text(),t.match(/[^.]*$/)[0]]:(l.push(`${e}/${t}`),[!1,!1])):[!1,!1])).then(e=>e.map(e=>{if(e[0]){let t=e[0].replace(/[\s]/g,"").length;return void 0===spcFileExtArray[e[1]]?t:Math.round(t*spcFileExtArray[e[1]])}return 0}).reduce((e,t)=>e+t,0)):0}let a=await Promise.all(e.map(async e=>await t(e[0],e[1],!0))).then(e=>e.reduce((e,t)=>e+t,0)),n=await Promise.all(e.map(async e=>await t(e[0],e[2],!1))).then(e=>e.reduce((e,t)=>e+t,0));return[a,n]}).then(e=>{let a=new Date(Date.now()),r=`${a.getFullYear()}-${o(a.getMonth()+1,2)}-${o(a.getDate(),2)}`;new Promise(e=>{function a(){t.length>0&&t[t.length-1].date===r?(t.pop(),a()):e(t[t.length-1])}a()}).then(a=>{let l=new Date(Date.now());t.push({date:r,textTotal:e[0],docTotal:e[1],textDiff:e[0]-a.textTotal,docDiff:e[1]-a.docTotal,writeDate:`${l.getFullYear()}-${o(l.getMonth()+1,2)}-${o(l.getDate(),2)}T${o(l.getHours(),2)}:${o(l.getMinutes(),2)}:${o(l.getSeconds(),2)}UTC+9`}),localStorage.setItem("characterCountLog",JSON.stringify(t)),q||n()})})}async function n(){
let e=[["<span>合</span>計",t[t.length-1].textTotal,t[t.length-1].docTotal]].concat(t.slice(0).reverse().splice(0,t.length-2).map(e=>[e.date,e.textDiff,e.docDiff])),a="";l.length>0&&(a=`<section><ul><li>Not Found: ${l.join("</li><li>Not found: ")}</li></ul></section>`,notFoundField.classList.add("not-found")),characterCountLogTable.innerHTML=`<p>小説制作 文字数ログ</p>\n        <div id="status-switch">\n          <label><input type="radio" name="period-switch" value="d7" checked>7日</label>\n          <label><input type="radio" name="period-switch" value="d30">30日</label>\n          <label><input type="radio" name="period-switch" value="all">全期間</label>\n        </div>\n        <div>\n          ${r(e,["日付","本文","その他"],"d7","data-table")}\n        </div>`,downloadButton=document.querySelector("#download-button"),downloadButton.href=URL.createObjectURL(new Blob([await s(JSON.stringify(t))],{type:"text/plain"})),notFoundField.innerHTML+=a;let n=document.querySelector("#data-table");document.querySelectorAll("#status-switch input").forEach(e=>{e.onchange=(()=>{n.classList=e.value})})}let l=[];t=localStorage.getItem("characterCountLog"),characterCountLogInitializeSwitch&&(localStorage.removeItem("characterCountLog"),t=null),t=null!==t?JSON.parse(t):[{date:"",textTotal:0,docTotal:0,textDiff:0,docDiff:0,writeDate:""}],a(),e()}if(e(),!q){uploadButton=document.querySelector("#upload-button");let a=new FileReader;uploadButton.onchange=(n=>{n&&a.readAsText(n.target.files[0]),a.onload=(()=>{t=JSON.parse(a.result),localStorage.setItem("characterCountLog",JSON.stringify(t)),e()})})}}});let h=window.innerHeight;window.onscroll=(()=>{a()}),document.onscroll=(()=>{a()}),window.addEventListener("unload",()=>{localStorage.setItem("scrollValueY",scrollValueY),localStorage.setItem("scrollValueX",scrollValueX)}),document.querySelector("#return-to-top").onclick=(()=>{document.scrollingElement.scroll({top:0,left:0,behavior:"smooth"})})}),window.addEventListener("mousedown",function(e){if(0===e.button){let e=Date.now();return window.addEventListener("mousedown",function(t){if(!(0===t.button&&Date.now()-e<300))return!0;location.reload()}),setTimeout(()=>!0,200)}}),window.onkeydown=(e=>{if("Enter"===e.code){let e=document.querySelector("body").getBoundingClientRect().height,t=Math.ceil(e-window.innerHeight),a=document.scrollingElement.scrollTop,n=0;n=0===a?t+100:a<t/2?0:a>=t/2&&a!==t?t+1:0,document.scrollingElement.scroll({top:n,left:0,behavior:"smooth"})}});