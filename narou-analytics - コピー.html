<title>なろうランキング解析くん</title>
<style>
body,
table {
  font-size: 13px;
}
table {
  border-collapse: collapse;
}
table + table {
  margin-top: 50px;
}
td {
  vertical-align: top;
  border: 1px solid #666;
}
tr:first-child .date::before,
tr:first-child .ncode::before,
tr:first-child .title::before,
tr:first-child .genre::before,
tr:first-child .general_firstup::before,
tr:first-child .general_all_no::before,
tr:first-child .global_point::before,
tr:first-child .fav_novel_cnt::before {
  display: block;
  padding: 1px;
  font-size: 65%;
  letter-spacing: -0.05em;
  color: #fff;
  background-color: #666;
}
tr:first-child .date::before {
  content: "ランクイン日";
}
tr:first-child .ncode::before {
  content: "Nコード";
}
tr:first-child .title::before {
  content: "タイトル";
}
tr:first-child .genre::before {
  content: "ジャンル";
}
tr:first-child .general_firstup::before {
  content: "初回掲載日";
}
tr:first-child .general_all_no::before {
  content: "全掲載部分数";
}
tr:first-child .global_point::before {
  content: "総合評価ポイント";
}
tr:first-child .fav_novel_cnt::before {
  content: "ブックマーク数";
}
.progress-frame {
  width: 200px;
  height: 25px;
  padding: 0;
  border: 1px solid #666;
}
.progress-bar {
  height: 100%;
  width: 0;
  background-color: #1e3;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
$(document).ready(function() {
  /*

  var

  */
  var url_rank_api = 'https://api.syosetu.com/rank/rankget/'
  var url_narou_api = 'https://api.syosetu.come/novelapi/api/'
  var out = 'jsonp'
  var rtype = 'd'
  var libtype = '2'
  var date_base_source = new Date()
  date_base_source.setDate(date_base_source.getDate() - 1)
  var period = 2
  var of = 'n-t-g-gf-ga-gp-f' // ncode-title-genre-general_firstup-general_all_no-global_point-fav_novel_cnt
  var array_no_recode = {ncode: '', title: '', genre: '', general_firstup: '', general_all_no: '', global_point: '', fav_novel_cnt: ''}
  var query_rank_forward = url_rank_api + '?out=' + out + '&libtype=' + libtype + '&rtype='
  var query_rank_backward = '-' + rtype
  var query_narou_base = url_narou_api + '?out=' + out + '&libtype=' + libtype + '&of=' + of + '&ncode='
  var array_union = new Array(period).fill(0)
  var array_cache = []
  var array_cache_existence = 0
  var index_ncode = ''
  var work_date = new Date()
  var carrier_repeat = []
  var count = 0
  var length_array_union_overall = 0
  var genre_list = {'101': '異世界〔恋愛〕',
                    '102': '現実世界〔恋愛〕',
                    '201': 'ハイファンタジー〔ファンタジー〕',
                    '202': 'ローファンタジー〔ファンタジー〕',
                    '301': '純文学〔文芸〕',
                    '302': 'ヒューマンドラマ〔文芸〕',
                    '303': '歴史〔文芸〕',
                    '304': '推理〔文芸〕',
                    '305': 'ホラー〔文芸〕',
                    '306': 'アクション〔文芸〕',
                    '307': 'コメディー〔文芸〕',
                    '401': 'VRゲーム〔SF〕',
                    '402': '宇宙〔SF〕',
                    '403': '空想科学〔SF〕',
                    '404': 'パニック〔SF〕',
                    '9901': '童話〔その他〕',
                    '9902': '詩〔その他〕',
                    '9903': 'エッセイ〔その他〕',
                    '9904': 'リプレイ〔その他〕',
                    '9999': 'その他〔その他〕',
                    '9801': 'ノンジャンル〔ノンジャンル〕'}
  var yesterday_source = new Date()
  yesterday_source.setDate(yesterday_source.getDate() - 1)
  var year_yesterday_source = yesterday_source.getFullYear()
  var month_yesterday_source = ('0' + (yesterday_source.getMonth() + 1)).slice(-2)
  var day_yesterday_source = ('0' + (yesterday_source.getDate())).slice(-2)
  var yesterday = year_yesterday_source + '/' + month_yesterday_source + '/' + day_yesterday_source
  var date_base_input = ''
  date_base_input = yesterday
  var date_base_source = new Date()
  var progress_value = 0
  var date_base_input_split_char = new RegExp('[-\/ \.]')
  var date_base_input_splited_char = []
  /*

  Run

  */
  $('#date').val(yesterday)
  $('#period').val(1)
  $('#run').on('click', function() {
    date_base_input = $('#date').val()
    period = Number($('#period').val())
    date_base_input_splited_char = date_base_input.split(date_base_input_split_char)
    date_base_source.setFullYear(date_base_input_splited_char[0])
    date_base_source.setMonth(Number(date_base_input_splited_char[1]) - 1)
    date_base_source.setDate(date_base_input_splited_char[2])
    getRankByPeriod(0, 0)
  })
  /*

  My function

  */
  function getRankByPeriod(carrier_date, carrier_time) {
    if (carrier_repeat.length === 0) {
      for (var i = period - 1; i >= 0; i--) {
        carrier_repeat[i] = 0
      }
    }
    if (carrier_date == 0 && carrier_time == 0) {
      for (var i = period - 1; i >= 0; i--) {
        var work_year = date_base_source.getFullYear().toString()
        var work_month = ('0' + (date_base_source.getMonth() + 1).toString()).slice(-2)
        var work_day = ('0' + date_base_source.getDate().toString()).slice(-2)
        var date = work_year + work_month + work_day
        carrier_repeat[i]++
        getRank(date, i)
      }
    } else {
      if (carrier_repeat[carrier_time] <= 3) {
        carrier_repeat[carrier_time]++
        getRank(carrier_date, carrier_time)
      } else {
        var error_year = carrier_date.substr(0, 4)
        var error_month = carrier_date.substr(4, 2)
        var error_day = carrier_date.substr(6, 2)
        $('.error-report').append('<p>' + error_year + '/' + error_month + '/' + error_day + ' のランキングを取得できませんでした。</p>')
      }
    }
  }
  function getRank(date, time) {
    var query_count = 0
    $.ajax({
      url: query_rank_forward + date + query_rank_backward,
      type: 'GET',
      dataType: out,
      cache: 'false',
      timeout: 3000,
    })
    .done(function(array_rank) {
      var length_array_rank = 0
      for (var i in array_rank) {
        length_array_rank++
        length_array_union_overall++
      }
      array_union[time] = new Array(length_array_rank).fill(0)
      for (var j = length_array_rank - 1; j >= 0; j--) {
        if (array_cache.length === 0) {
          getNarou(j, array_rank, time, date)
        } else {
          var length_array_cache = 0
          for (var k in array_cache) {
            length_array_cache++
          }
          for (var l = length_array_cache- 1; l >= 0; l--) {
            array_cache_existence = array_cache[l]['ncode'].indexOf(array_rank[j])
            if (array_cache_existence < 0) {
              getNarou(j, array_rank, time, date)
            } else {
              array_union[time][rank] = Object.assign(Object.assign({'date': date}, array_cache[1]), array_rank[rank])
              count++
              progressBar()
              if (count >= length_array_union_overall) {
                outpuArray()
              }
            }
          }
        }
      }
    })
    .fail(function() {
      getRankByPeriod(date, time)
    })
  }
  function getNarou(rank, array_rank, time, date) {
    index_ncode = array_rank[rank]['ncode']
    $.ajax({
      url: query_narou_base + index_ncode,
      type: 'GET',
      dataType: out,
      cache: 'false',
      timeout: 3000,
    })
    .done(function(array_narou) {
      var check_existence = 0
      for (var i in array_narou[1]) {
        check_existence++
      }
      if (check_existence >= 1) {
        array_union[time][rank] = Object.assign(Object.assign({'date': date}, array_narou[1]), array_rank[rank])
      } else {
        array_union[time][rank] = Object.assign(Object.assign({'date': date}, array_no_recode), array_rank[rank])
      }
      count++
      progressBar()
      if (count >= length_array_union_overall) {
        outpuArray()
      }
    })
    .fail(function() {
      alert("Error: Getting parameter at 2nd Ajax is failed.")
    })
  }
  function outpuArray() {
    for (var i = 0; i <= array_union.length - 1; i++) {
      var table_date = i + 1
      $('#output-area').append('<table class="date-' + (i + 1) + '"></table>')
      var length_array_union = 0
      for (var l in array_union[i]) {
        length_array_union++
      }
      for (var j = 0; j <= length_array_union - 1; j++) {
        var table_rank = j + 1
        var table_genre = genre_list[array_union[i][j]['genre']]
        $('table.date-' + table_date).append('<tr class="rank-' + (j + 1) + '"></tr>')
        $('table.date-' + table_date + ' tr.rank-' + table_rank).append('<td class="date">' + array_union[i][j]['date'] + '</td>')
        $('table.date-' + table_date + ' tr.rank-' + table_rank).append('<td class="ncode">' + array_union[i][j]['ncode'] + '</td>')
        $('table.date-' + table_date + ' tr.rank-' + table_rank).append('<td class="title">' + array_union[i][j]['title'] + '</td>')
        $('table.date-' + table_date + ' tr.rank-' + table_rank).append('<td class="genre">' + table_genre + '</td>')
        $('table.date-' + table_date + ' tr.rank-' + table_rank).append('<td class="general_firstup">' + array_union[i][j]['general_firstup'] + '</td>')
        $('table.date-' + table_date + ' tr.rank-' + table_rank).append('<td class="general_all_no">' + array_union[i][j]['general_all_no'] + '</td>')
        $('table.date-' + table_date + ' tr.rank-' + table_rank).append('<td class="global_point">' + array_union[i][j]['global_point'] + '</td>')
        $('table.date-' + table_date + ' tr.rank-' + table_rank).append('<td class="fav_novel_cnt">' + array_union[i][j]['fav_novel_cnt'] + '</td>')
      }
    }
  }
  function progressBar() {
    progress_value = count / length_array_union_overall * 100
    $('.progress-bar').css('width', progress_value + '%')
  }
})
</script>
<div id="input-area">
  <label>取得基準日</label><input type="text" id="date"><br>
  <label>取得基準日を含めて過去何日間分？</label><input type="text" id="period"><br>
  <button id="run">取得開始</button>
</div>
<div id="error-report">
  <div class="error-report"></div>
</div>
<div id="progress-bar-area">
  <div class="progress-frame">
    <div class="progress-bar"></div>
  </div>
</div>
<div id="output-area"></div>
